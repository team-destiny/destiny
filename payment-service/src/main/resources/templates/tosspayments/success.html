<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê²°ì œ ì„±ê³µ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .box {
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .success { background: #e8f5e9; }
    .error { background: #ffebee; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
<h1>ê²°ì œ ì²˜ë¦¬ ì¤‘...</h1>

<div id="status" class="box">
  <p>â³ ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
</div>

<h3>ğŸ“‹ ê²°ì œ ì •ë³´</h3>
<p id="paymentKey"></p>
<p id="orderId"></p>
<p id="amount"></p>

<h3>ğŸ” ì„œë²„ ì‘ë‹µ</h3>
<pre id="response">ëŒ€ê¸° ì¤‘...</pre>

<script>
  // URLì—ì„œ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const urlParams = new URLSearchParams(window.location.search);
  const paymentKey = urlParams.get("paymentKey");
  const orderId = urlParams.get("orderId");
  const amount = urlParams.get("amount");

  // í™”ë©´ì— ì •ë³´ í‘œì‹œ
  document.getElementById("paymentKey").textContent = "paymentKey: " + paymentKey;
  document.getElementById("orderId").textContent = "ì£¼ë¬¸ë²ˆí˜¸: " + orderId;
  document.getElementById("amount").textContent = "ê²°ì œ ê¸ˆì•¡: " + amount + "ì›";

  // ì„œë²„ì— ê²°ì œ ìŠ¹ì¸ ìš”ì²­
  async function confirmPayment() {
    const statusDiv = document.getElementById("status");
    const responseDiv = document.getElementById("response");

    try {
      // 1. ì„œë²„ì— POST ìš”ì²­
      const response = await fetch("/v1/payments/tosspayments/confirm", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          paymentKey: paymentKey,
          orderId: orderId,
          amount: amount,
        }),
      });

      // 2. ì„œë²„ ì‘ë‹µ ë°›ê¸°
      const json = await response.json();

      // 3. í™”ë©´ì— ì‘ë‹µ í‘œì‹œ
      responseDiv.textContent = JSON.stringify(json, null, 2);

      // 4. ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬
      if (json.success && json.data && json.data.paymentSuccess) {
        // âœ… ê²°ì œ ì„±ê³µ
        statusDiv.className = "box success";
        statusDiv.innerHTML = `
            <h2>âœ… ê²°ì œ ì„±ê³µ!</h2>
            <p>${json.message}</p>
            <p>ì£¼ë¬¸ë²ˆí˜¸: ${json.data.orderId}</p>
            <p>ê²°ì œê¸ˆì•¡: ${json.data.finalAmount}ì›</p>
          `;

        console.log("ê²°ì œ ì„±ê³µ:", json);
      } else {
        // âŒ ê²°ì œ ì‹¤íŒ¨
        statusDiv.className = "box error";
        statusDiv.innerHTML = `
            <h2>âŒ ê²°ì œ ì‹¤íŒ¨</h2>
            <p>${json.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</p>
            ${json.data ? `<p>ì˜¤ë¥˜ ì½”ë“œ: ${json.data.failCode}</p>` : ''}
            ${json.data ? `<p>ì˜¤ë¥˜ ë©”ì‹œì§€: ${json.data.failMessage}</p>` : ''}
          `;

        console.error("ê²°ì œ ì‹¤íŒ¨:", json);
      }

    } catch (error) {
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±
      statusDiv.className = "box error";
      statusDiv.innerHTML = `
          <h2>âŒ ì˜¤ë¥˜ ë°œìƒ</h2>
          <p>ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
          <p>${error.message}</p>
        `;

      responseDiv.textContent = "ì˜¤ë¥˜: " + error.message;
      console.error("í†µì‹  ì˜¤ë¥˜:", error);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
  confirmPayment();
</script>
</body>
</html>